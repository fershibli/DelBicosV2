name: 01 - An√°lise Sem√¢ntica de Vers√£o

on:
  pull_request:
    # Acionado quando um PR √© aberto ou atualizado, tendo 'main' como branch de destino
    branches:
      - main
    types: [opened, synchronize, reopened]

# Permiss√µes necess√°rias para o job poder escrever um coment√°rio no PR
permissions:
  pull-requests: write
  contents: read # Necess√°rio para fazer o checkout e ler os commits

jobs:
  analise-semantica:
    # Condi√ß√£o: Este job s√≥ vai rodar se o PR vier da branch 'stag'
    if: github.head_ref == 'stag'
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Fazer checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Puxa todo o hist√≥rico para poder comparar as branches

      - name: 2. Analisar commits da Pull Request
        id: analisar_commits
        run: |
          # Compara a branch de origem (stag) com a de destino (main) e lista os assuntos dos commits
          # A sintaxe √© 'destino..origem'
          COMMITS=$(git log origin/${{ github.base_ref }}..origin/${{ github.head_ref }} --pretty=%s)

          echo "Commits a analisar:"
          echo "$COMMITS"
          
          # L√≥gica de versionamento com as suas regras customizadas
          BUMP_TYPE="Nenhum"
          BUMP_REASON=""

          # A ordem √© importante: checamos do maior (MAJOR) para o menor (PATCH)
          if echo "$COMMITS" | grep -q -i "^refactor:"; then
            BUMP_TYPE="MAJOR"
            BUMP_REASON="Um commit 'refactor:' foi encontrado, indicando uma atualiza√ß√£o MAJOR."
          elif echo "$COMMITS" | grep -q -i "^feat:" || echo "$COMMITS" | grep -q -i "^feature:"; then
            BUMP_TYPE="MINOR"
            BUMP_REASON="Um commit 'feat:' ou 'feature:' foi encontrado, indicando uma atualiza√ß√£o MINOR."
          elif echo "$COMMITS" | grep -q -i "^fix:"; then
            BUMP_TYPE="PATCH"
            BUMP_REASON="Um commit 'fix:' foi encontrado, indicando uma atualiza√ß√£o PATCH."
          else
            BUMP_TYPE="Nenhum"
            BUMP_REASON="Nenhum commit sem√¢ntico (fix, feature, refactor) foi detectado."
          fi
          
          echo "BUMP_TYPE=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "BUMP_REASON=$BUMP_REASON" >> $GITHUB_OUTPUT
          
          # Prepara a lista de commits para o coment√°rio (escapando caracteres especiais)
          COMMITS="${COMMITS//'%'/'%25'}"
          COMMITS="${COMMITS//$'\n'/'%0A'}"
          COMMITS="${COMMITS//$'\r'/'%0D'}"
          echo "COMMIT_LIST=$COMMITS" >> $GITHUB_OUTPUT

      - name: 3. Comentar no PR com o resultado
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const bumpType = "${{ steps.analisar_commits.outputs.BUMP_TYPE }}";
            const bumpReason = "${{ steps.analisar_commits.outputs.BUMP_REASON }}";
            const commits = `${{ steps.analisar_commits.outputs.COMMIT_LIST }}`.replace(/%0A/g, '\n');
            const botCommentIdentifier = "";
            
            let body = `## ü§ñ An√°lise de Versionamento Sem√¢ntico\n`;
            body += `${botCommentIdentifier}\n\n`;
            body += `**Atualiza√ß√£o de vers√£o detectada:** \`${bumpType}\`\n`;
            body += `**Justificativa:** ${bumpReason}\n\n`;
            
            if (bumpType === "Nenhum") {
               body += `> ‚ö†Ô∏è **Aten√ß√£o:** Nenhum commit com os prefixos \`fix:\`, \`feature:\` ou \`refactor:\` foi encontrado. A verifica√ß√£o falhar√°.\n\n`;
            }
            
            body += `### Commits Analisados:\n`;
            body += "```\n" + (commits || "Nenhum commit novo encontrado na an√°lise.") + "\n```";

            // L√≥gica para evitar spam: atualiza o coment√°rio do bot se ele j√° existir
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes(botCommentIdentifier)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: 4. Falhar a verifica√ß√£o se nenhum tipo for detectado
        if: steps.analisar_commits.outputs.BUMP_TYPE == 'Nenhum'
        run: |
          echo "Erro: A verifica√ß√£o falhou pois nenhum commit sem√¢ntico (fix, feature, refactor) foi encontrado."
          echo "Por favor, adicione um commit com o prefixo apropriado na branch 'stag' antes de fazer o merge."
          exit 1